name: Deploy to Render

on:
  # DÃ©ploiement automatique aprÃ¨s build Docker rÃ©ussi
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    branches: [main]

  # DÃ©ploiement manuel
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        run: |
          echo "ğŸš€ DÃ©ploiement automatique sur Render..."
          echo "Render dÃ©tectera automatiquement la nouvelle image Docker"
          echo "Image: ghcr.io/${{ github.repository }}:latest"

          # Note: Avec render.yaml et autoDeploy: true, Render dÃ©tecte
          # automatiquement les nouvelles images Docker sans webhook

      - name: Wait for deployment
        run: |
          echo "â³ Attendre 2 minutes pour le dÃ©ploiement Render..."
          sleep 120

      - name: Verify deployment
        run: |
          # Remplacez par votre URL Render une fois dÃ©ployÃ©
          RENDER_URL="https://pdf-xml-asycuda-api.onrender.com"

          echo "ğŸ” VÃ©rification du dÃ©ploiement sur $RENDER_URL..."

          # Retry logic pour gÃ©rer le cold start
          for i in {1..5}; do
            if curl -f -s "$RENDER_URL/api/v1/health" > /dev/null; then
              echo "âœ… API disponible!"
              curl -s "$RENDER_URL/api/v1/health" | jq .
              exit 0
            else
              echo "Tentative $i/5 - En attente..."
              sleep 30
            fi
          done

          echo "âš ï¸  Impossible de vÃ©rifier le dÃ©ploiement"
          echo "VÃ©rifiez manuellement: $RENDER_URL/api/v1/health"
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š RÃ©sumÃ© du dÃ©ploiement"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Dashboard Render: https://dashboard.render.com"
          echo "ğŸ“– Documentation: $RENDER_URL/docs"
          echo "â¤ï¸  Health Check: $RENDER_URL/api/v1/health"

  # Optionnel: Notifier l'Ã©quipe
  notify:
    name: Notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment notification
        run: |
          STATUS="${{ needs.deploy.result }}"

          if [ "$STATUS" == "success" ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi sur Render!"
          elif [ "$STATUS" == "failure" ]; then
            echo "âŒ Ã‰chec du dÃ©ploiement sur Render"
          else
            echo "âš ï¸  Statut de dÃ©ploiement: $STATUS"
          fi

          # Ici vous pouvez ajouter des notifications Slack, Discord, Email, etc.
          # Exemple Slack webhook:
          # curl -X POST $SLACK_WEBHOOK -d '{"text":"DÃ©ploiement '$STATUS'"}'
