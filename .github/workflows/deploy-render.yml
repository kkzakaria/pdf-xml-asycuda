name: Deploy to Render

on:
  # DÃ©ploiement automatique aprÃ¨s build Docker rÃ©ussi
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    # Suppression de la restriction "branches" pour permettre les tags

  # DÃ©ploiement manuel avec sÃ©lection de version
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Docker image tag to deploy (leave empty for latest)'
        required: false
        type: string

jobs:
  deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    environment: render
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Docker image tag
        id: image_tag
        run: |
          # DÃ©tecter le tag Ã  utiliser selon le contexte
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # DÃ©ploiement manuel avec tag spÃ©cifiÃ©
            if [ -n "${{ inputs.image_tag }}" ]; then
              TAG="${{ inputs.image_tag }}"
            else
              TAG="latest"
            fi
          elif [ "${{ github.event.workflow_run.event }}" == "push" ]; then
            # DÃ©ploiement automatique aprÃ¨s build Docker
            # RÃ©cupÃ©rer le ref qui a dÃ©clenchÃ© le workflow_run
            TRIGGER_REF="${{ github.event.workflow_run.head_branch }}"

            # VÃ©rifier si c'est un tag de version (avec ou sans suffixe)
            if [[ "$TRIGGER_REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              TAG="$TRIGGER_REF"
              echo "ğŸ“¦ Tag de version dÃ©tectÃ©: $TAG"
            else
              TAG="latest"
              echo "ğŸ“¦ Branche main dÃ©tectÃ©e, utilisation de: $TAG"
            fi
          else
            TAG="latest"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸  Image Docker Ã  dÃ©ployer: ghcr.io/${{ github.repository }}:$TAG"

      - name: Wait for image availability
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
        run: |
          echo "â³ Attente de la disponibilitÃ© complÃ¨te de l'image dans GHCR..."
          echo "Image cible: ghcr.io/${{ github.repository }}:${IMAGE_TAG}"
          echo ""
          echo "ğŸ“Š Contexte:"
          echo "  - Le workflow Docker peut prendre 30-60s pour pusher toutes les plateformes"
          echo "  - Attente de sÃ©curitÃ©: 60 secondes"
          echo ""
          sleep 60

      - name: Verify image in registry
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” VÃ©rification de l'image dans GHCR..."
          IMAGE_URL="ghcr.io/${{ github.repository }}:${IMAGE_TAG}"

          # Login au registre pour accÃ©der aux images privÃ©es
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # VÃ©rification avec retries (max 5 tentatives, 15s entre chaque)
          MAX_RETRIES=5
          RETRY_DELAY=15

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Tentative $i/$MAX_RETRIES..."

            if docker manifest inspect "$IMAGE_URL" > /dev/null 2>&1; then
              echo "âœ… Image vÃ©rifiÃ©e et disponible dans GHCR!"
              echo "ğŸ“¦ Manifest:"
              docker manifest inspect "$IMAGE_URL" | jq -r '.manifests[] | "  - \(.platform.os)/\(.platform.architecture)"'
              exit 0
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "âš ï¸  Image non encore disponible, nouvelle tentative dans ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              else
                echo "âŒ Erreur: Image toujours indisponible aprÃ¨s $MAX_RETRIES tentatives"
                echo "Image recherchÃ©e: $IMAGE_URL"
                echo ""
                echo "VÃ©rification manuelle nÃ©cessaire:"
                echo "  docker manifest inspect $IMAGE_URL"
                exit 1
              fi
            fi
          done

      - name: Deploy to Render
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ğŸš€ DÃ©ploiement automatique sur Render..."
          echo "Image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}"
          echo ""
          echo "ğŸ“‹ Contexte de dÃ©ploiement:"
          echo "  - Event: ${{ github.event_name }}"
          echo "  - Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "  - Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "  - Image tag: ${IMAGE_TAG}"
          echo ""

          # Force Render Ã  repuller l'image :latest via l'API
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            echo "ğŸ”„ DÃ©clenchement du redÃ©ploiement via API Render..."

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache":"clear"}')

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… RedÃ©ploiement dÃ©clenchÃ© avec succÃ¨s!"
              echo "$BODY" | jq -r '.id' || echo "$BODY"
            else
              echo "âš ï¸  Erreur lors du dÃ©clenchement (HTTP $HTTP_CODE)"
              echo "$BODY"
              echo ""
              echo "ğŸ’¡ Le dÃ©ploiement automatique de Render prendra le relais."
            fi
          else
            echo "â„¹ï¸  API Render non configurÃ©e (RENDER_API_KEY ou RENDER_SERVICE_ID manquant)"
            echo "ğŸ’¡ Render dÃ©tectera automatiquement la nouvelle image :latest"
            echo "   Configuration requise dans Settings â†’ Secrets:"
            echo "   - RENDER_API_KEY: ClÃ© API depuis https://dashboard.render.com/u/settings"
            echo "   - RENDER_SERVICE_ID: ID du service (srv-xxxxx)"
          fi

      - name: Wait for deployment
        run: |
          echo "â³ Attendre 2 minutes pour le dÃ©ploiement Render..."
          sleep 120

      - name: Verify deployment
        run: |
          # Remplacez par votre URL Render une fois dÃ©ployÃ©
          RENDER_URL="https://pdf-xml-asycuda-api.onrender.com"

          echo "ğŸ” VÃ©rification du dÃ©ploiement sur $RENDER_URL..."

          # Retry logic pour gÃ©rer le cold start
          for i in {1..5}; do
            if curl -f -s "$RENDER_URL/api/v1/health" > /dev/null; then
              echo "âœ… API disponible!"
              curl -s "$RENDER_URL/api/v1/health" | jq .
              exit 0
            else
              echo "Tentative $i/5 - En attente..."
              sleep 30
            fi
          done

          echo "âš ï¸  Impossible de vÃ©rifier le dÃ©ploiement"
          echo "VÃ©rifiez manuellement: $RENDER_URL/api/v1/health"
          exit 1

      - name: Deployment summary
        if: always()
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
          RENDER_URL: "https://pdf-xml-asycuda-api.onrender.com"
        run: |
          echo "ğŸ“Š RÃ©sumÃ© du dÃ©ploiement"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repository: ${{ github.repository }}"
          echo "Image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Dashboard Render: https://dashboard.render.com"
          echo "ğŸ“– Documentation: ${RENDER_URL}/docs"
          echo "â¤ï¸  Health Check: ${RENDER_URL}/api/v1/health"

  # Optionnel: Notifier l'Ã©quipe
  notify:
    name: Notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment notification
        run: |
          STATUS="${{ needs.deploy.result }}"

          if [ "$STATUS" == "success" ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi sur Render!"
          elif [ "$STATUS" == "failure" ]; then
            echo "âŒ Ã‰chec du dÃ©ploiement sur Render"
          else
            echo "âš ï¸  Statut de dÃ©ploiement: $STATUS"
          fi

          # Ici vous pouvez ajouter des notifications Slack, Discord, Email, etc.
          # Exemple Slack webhook:
          # curl -X POST $SLACK_WEBHOOK -d '{"text":"DÃ©ploiement '$STATUS'"}'
